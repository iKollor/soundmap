version: "3.8"

services:
    # ==========================================
    # Database & Cache
    # ==========================================
    postgres:
        image: nickblah/postgis:17-bookworm-postgis-3.6
        container_name: soundmap-postgres
        restart: unless-stopped
        networks:
            - soundmap-network
        environment:
            POSTGRES_USER: ${POSTGRES_USER}
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
            POSTGRES_DB: ${POSTGRES_DB}
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./docker/postgres/init-postgis.sql:/docker-entrypoint-initdb.d/init-postgis.sql:ro
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
            interval: 10s
            timeout: 5s
            retries: 5

    redis:
        image: redis:7.4-alpine
        container_name: soundmap-redis
        restart: unless-stopped
        networks:
            - soundmap-network
        command: redis-server --appendonly yes
        volumes:
            - redis_data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5

    # ==========================================
    # Object Storage (S3)
    # ==========================================
    garage:
        build:
            context: ./docker/garage
            dockerfile: Dockerfile
        container_name: soundmap-garage
        restart: unless-stopped
        networks:
            - soundmap-network
        environment:
            GARAGE_ALLOW_WORLD_READABLE_SECRETS: "true"
            GARAGE_CAPACITY: ${GARAGE_CAPACITY:-10G}
            GARAGE_ZONE: ${GARAGE_ZONE:-local}
            S3_ACCESS_KEY: ${S3_ACCESS_KEY}
        volumes:
            - garage_data:/var/lib/garage/data
            - garage_meta:/var/lib/garage/meta
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:3902/health || exit 1"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    # ==========================================
    # Database Migrations
    # ==========================================
    migrate:
        build:
            context: .
            dockerfile: packages/database/Dockerfile
        container_name: soundmap-migrate
        networks:
            - soundmap-network
        environment:
            DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
        depends_on:
            postgres:
                condition: service_healthy
        restart: "no"

    # ==========================================
    # Application Services
    # ==========================================
    web:
        build:
            context: .
            dockerfile: apps/web/Dockerfile
        container_name: soundmap-web
        restart: unless-stopped
        networks:
            - soundmap-network
        environment:
            NODE_ENV: production
            DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
            REDIS_URL: redis://redis:6379
            # S3 Configuration (internal network)
            S3_ENDPOINT: http://garage:3900
            S3_REGION: garage
            S3_ACCESS_KEY: ${S3_ACCESS_KEY}
            S3_SECRET_KEY: ${S3_SECRET_KEY}
            S3_BUCKET_SOUNDS: ${S3_BUCKET_SOUNDS:-sounds}
            S3_BUCKET_WAVEFORMS: ${S3_BUCKET_WAVEFORMS:-waveforms}
            S3_FORCE_PATH_STYLE: "true"
            # Internal webhook URL for worker callbacks
            INTERNAL_WEBHOOK_URL: http://web:3000
            WORKER_SECRET: ${NEXTAUTH_SECRET}
            # App Config
            NEXT_PUBLIC_APP_URL: ${SERVICE_URL_WEB}
            NEXT_PUBLIC_MAP_STYLE_URL: ${NEXT_PUBLIC_MAP_STYLE_URL}
            # Auth
            AUTH_TRUST_HOST: "true"
            NEXTAUTH_URL: ${SERVICE_URL_WEB}
            NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
            KEYCLOAK_ISSUER: ${KEYCLOAK_ISSUER}
            KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID}
            KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            garage:
                condition: service_healthy
            migrate:
                condition: service_completed_successfully

    worker:
        build:
            context: .
            dockerfile: apps/worker/Dockerfile
        container_name: soundmap-worker
        restart: unless-stopped
        networks:
            - soundmap-network
        environment:
            NODE_ENV: production
            DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
            REDIS_URL: redis://redis:6379
            # S3 Configuration (internal network)
            S3_ENDPOINT: http://garage:3900
            S3_REGION: garage
            S3_ACCESS_KEY: ${S3_ACCESS_KEY}
            S3_SECRET_KEY: ${S3_SECRET_KEY}
            S3_BUCKET_SOUNDS: ${S3_BUCKET_SOUNDS:-sounds}
            S3_BUCKET_WAVEFORMS: ${S3_BUCKET_WAVEFORMS:-waveforms}
            S3_FORCE_PATH_STYLE: "true"
            # Worker Config (internal network)
            INTERNAL_WEBHOOK_URL: http://web:3000
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            garage:
                condition: service_healthy
            migrate:
                condition: service_completed_successfully

volumes:
    postgres_data:
    redis_data:
    garage_data:
    garage_meta:

networks:
    soundmap-network:
        driver: bridge
